<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>QR JSON Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f6fa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .container {
        background: #fff;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 100%;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #2f3640;
      }

      button {
        background: #0984e3;
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: 0.2s ease;
      }

      button:hover {
        background: #74b9ff;
      }

      pre {
        background: #f1f2f6;
        padding: 10px;
        border-radius: 8px;
        text-align: left;
        font-size: 13px;
        max-height: 200px;
        overflow: auto;
      }

      #qrcode {
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QR JSON Üretici</h1>

      <!-- Gizli alanlar -->
      <input type="hidden" id="busId" value="1" />
      <input type="hidden" id="secret" value="test" />

      <button id="generate">JSON ve QR Oluştur</button>

      <h2>JSON</h2>
      <pre id="result"></pre>

      <h2>QR Kodu</h2>
      <div id="qrcode"></div>
    </div>

    <script>
      async function generateHmac(payload, secret) {
        const enc = new TextEncoder();
        const key = await crypto.subtle.importKey(
          "raw",
          enc.encode(secret),
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["sign"]
        );
        const sigBuffer = await crypto.subtle.sign(
          "HMAC",
          key,
          enc.encode(payload)
        );
        const sigArray = Array.from(new Uint8Array(sigBuffer));
        return btoa(String.fromCharCode(...sigArray));
      }

      document
        .getElementById("generate")
        .addEventListener("click", async () => {
          const busId = document.getElementById("busId").value;
          const secret = document.getElementById("secret").value;
          const ts = Math.floor(Date.now() / 1000);

          const payload = JSON.stringify({ bus_id: busId, ts });
          const sig = await generateHmac(payload, secret);

          const json = { bus_id: busId, ts, sig };
          const jsonStr = JSON.stringify(json, null, 2);
          document.getElementById("result").textContent = jsonStr;

          document.getElementById("qrcode").innerHTML = "";
          new QRCode(document.getElementById("qrcode"), {
            text: JSON.stringify(json),
            width: 200,
            height: 200,
          });
        });
    </script>
  </body>
</html>
